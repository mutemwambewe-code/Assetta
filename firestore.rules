/**
 * @fileoverview Firestore Security Rules for PropEase Zambia.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for all data. Each user can only access their own data.
 *
 * Data Structure:
 * All data is nested under /users/{userId}, which represents a user's private data tree. This includes properties, tenants, message logs, and templates.
 *
 * Key Security Decisions:
 * - Users can only list their own data (e.g., tenants, properties).
 * - No global admin roles are defined in this prototype.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is made by a signed-in user.
     * @param {string} userId The user ID to compare against the authenticated user's ID.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the request is made by the owner of the resource.
     * @param {string} userId The user ID to compare against the authenticated user's ID.
     * @return {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the request is made by the owner of the resource and the resource exists.
     * @param {string} userId The user ID to compare against the authenticated user's ID.
     * @return {boolean} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Rules for user documents.  Users can only read/write their own user document.
     * @path /users/{userId}
     * @allow (create) User 'AUvNYg10hoXIAkcBxgsnsPnBzYo1' can create their own user document.
     * @deny (create) User 'randomUserId' cannot create a document for user 'AUvNYg10hoXIAkcBxgsnsPnBzYo1'.
     * @allow (get) User 'AUvNYg10hoXIAkcBxgsnsPnBzYo1' can get their own user document.
     * @deny (get) User 'randomUserId' cannot get the user document for user 'AUvNYg10hoXIAkcBxgsnsPnBzYo1'.
     * @allow (update) User 'AUvNYg10hoXIAkcBxgsnsPnBzYo1' can update their own user document.
     * @deny (update) User 'randomUserId' cannot update the user document for user 'AUvNYg10hoXIAkcBxgsnsPnBzYo1'.
     * @allow (delete) User 'AUvNYg10hoXIAkcBxgsnsPnBzYo1' can delete their own user document.
     * @deny (delete) User 'randomUserId' cannot delete the user document for user 'AUvNYg10hoXIAkcBxgsnsPnBzYo1'.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);

        /**
         * @description Rules for properties owned by a user. Only the owner can read/write their properties.
         * @path /users/{userId}/properties/{propertyId}
         * @allow (create) User 'AUvNYg10hoXIAkcBxgsnsPnBzYo1' can create a property under their user document.
         * @deny (create) User 'randomUserId' cannot create a property under user 'AUvNYg10hoXIAkcBxgsnsPnBzYo1'.
         * @allow (get) User 'AUvNYg10hoXIAkcBxgsnsPnBzYo1' can get a property under their user document.
         * @deny (get) User 'randomUserId' cannot get a property under user 'AUvNYg10hoXIAkcBxgsnsPnBzYo1'.
         * @allow (list) User 'AUvNYg10hoXIAkcBxgsnsPnBzYo1' can list the properties under their user document.
         * @deny (list) User 'randomUserId' cannot list properties under user 'AUvNYg10hoXIAkcBxgsnsPnBzYo1'.
         * @allow (update) User 'AUvNYg10hoXIAkcBxgsnsPnBzYo1' can update a property under their user document.
         * @deny (update) User 'randomUserId' cannot update a property under user 'AUvNYg10hoXIAkcBxgsnsPnBzYo1'.
         * @allow (delete) User 'AUvNYg10hoXIAkcBxgsnsPnBzYo1' can delete a property under their user document.
         * @deny (delete) User 'randomUserId' cannot delete a property under user 'AUvNYg10hoXIAkcBxgsnsPnBzYo1'.
         * @principle Enforces document ownership for writes.
         */
        match /properties/{propertyId} {
          allow get: if isOwner(userId);
          allow list: if isOwner(userId);
          allow create: if isOwner(userId);
          allow update: if isExistingOwner(userId);
          allow delete: if isExistingOwner(userId);
        }

        /**
         * @description Rules for tenants of a user. Only the owner can read/write their tenants.
         * @path /users/{userId}/tenants/{tenantId}
         * @allow (create) User 'AUvNYg10hoXIAkcBxgsnsPnBzYo1' can create a tenant under their user document.
         * @deny (create) User 'randomUserId' cannot create a tenant under user 'AUvNYg10hoXIAkcBxgsnsPnBzYo1'.
         * @allow (get) User 'AUvNYg10hoXIAkcBxgsnsPnBzYo1' can get a tenant under their user document.
         * @deny (get) User 'randomUserId' cannot get a tenant under user 'AUvNYg10hoXIAkcBxgsnsPnBzYo1'.
         * @allow (list) User 'AUvNYg10hoXIAkcBxgsnsPnBzYo1' can list the tenants under their user document.
         * @deny (list) User 'randomUserId' cannot list tenants under user 'AUvNYg10hoXIAkcBxgsnsPnBzYo1'.
         * @allow (update) User 'AUvNYg10hoXIAkcBxgsnsPnBzYo1' can update a tenant under their user document.
         * @deny (update) User 'randomUserId' cannot update a tenant under user 'AUvNYg10hoXIAkcBxgsnsPnBzYo1'.
         * @allow (delete) User 'AUvNYg10hoXIAkcBxgsnsPnBzYo1' can delete a tenant under their user document.
         * @deny (delete) User 'randomUserId' cannot delete a tenant under user 'AUvNYg10hoXIAkcBxgsnsPnBzYo1'.
         * @principle Enforces document ownership for writes.
         */
        match /tenants/{tenantId} {
          allow get: if isOwner(userId);
          allow list: if isOwner(userId);
          allow create: if isOwner(userId);
          allow update: if isExistingOwner(userId);
          allow delete: if isExistingOwner(userId);
        }

        /**
         * @description Rules for message logs of a user. Only the owner can read/write their message logs.
         * @path /users/{userId}/messagelogs/{messagelogId}
         * @allow (create) User 'AUvNYg10hoXIAkcBxgsnsPnBzYo1' can create a messagelog under their user document.
         * @deny (create) User 'randomUserId' cannot create a messagelog under user 'AUvNYg10hoXIAkcBxgsnsPnBzYo1'.
         * @allow (get) User 'AUvNYg10hoXIAkcBxgsnsPnBzYo1' can get a messagelog under their user document.
         * @deny (get) User 'randomUserId' cannot get a messagelog under user 'AUvNYg10hoXIAkcBxgsnsPnBzYo1'.
         * @allow (list) User 'AUvNYg10hoXIAkcBxgsnsPnBzYo1' can list the messagelogs under their user document.
         * @deny (list) User 'randomUserId' cannot list messagelogs under user 'AUvNYg10hoXIAkcBxgsnsPnBzYo1'.
         * @allow (update) User 'AUvNYg10hoXIAkcBxgsnsPnBzYo1' can update a messagelog under their user document.
         * @deny (update) User 'randomUserId' cannot update a messagelog under user 'AUvNYg10hoXIAkcBxgsnsPnBzYo1'.
         * @allow (delete) User 'AUvNYg10hoXIAkcBxgsnsPnBzYo1' can delete a messagelog under their user document.
         * @deny (delete) User 'randomUserId' cannot delete a messagelog under user 'AUvNYg10hoXIAkcBxgsnsPnBzYo1'.
         * @principle Enforces document ownership for writes.
         */
        match /messagelogs/{messagelogId} {
          allow get: if isOwner(userId);
          allow list: if isOwner(userId);
          allow create: if isOwner(userId);
          allow update: if isExistingOwner(userId);
          allow delete: if isExistingOwner(userId);
        }

        /**
         * @description Rules for message templates of a user. Only the owner can read/write their message templates.
         * @path /users/{userId}/templates/{templateId}
         * @allow (create) User 'AUvNYg10hoXIAkcBxgsnsPnBzYo1' can create a template under their user document.
         * @deny (create) User 'randomUserId' cannot create a template under user 'AUvNYg10hoXIAkcBxgsnsPnBzYo1'.
         * @allow (get) User 'AUvNYg10hoXIAkcBxgsnsPnBzYo1' can get a template under their user document.
         * @deny (get) User 'randomUserId' cannot get a template under user 'AUvNYg10hoXIAkcBxgsnsPnBzYo1'.
         * @allow (list) User 'AUvNYg10hoXIAkcBxgsnsPnBzYo1' can list the templates under their user document.
         * @deny (list) User 'randomUserId' cannot list templates under user 'AUvNYg10hoXIAkcBxgsnsPnBzYo1'.
         * @allow (update) User 'AUvNYg10hoXIAkcBxgsnsPnBzYo1' can update a template under their user document.
         * @deny (update) User 'randomUserId' cannot update a template under user 'AUvNYg10hoXIAkcBxgsnsPnBzYo1'.
         * @allow (delete) User 'AUvNYg10hoXIAkcBxgsnsPnBzYo1' can delete a template under their user document.
         * @deny (delete) User 'randomUserId' cannot delete a template under user 'AUvNYg10hoXIAkcBxgsnsPnBzYo1'.
         * @principle Enforces document ownership for writes.
         */
        match /templates/{templateId} {
          allow get: if isOwner(userId);
          allow list: if isOwner(userId);
          allow create: if isOwner(userId);
          allow update: if isExistingOwner(userId);
          allow delete: if isExistingOwner(userId);
        }
    }
  }
}