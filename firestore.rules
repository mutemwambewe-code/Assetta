/**
 * @fileoverview Firestore Security Rules for PropEase Zambia.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for all data stored
 * within user-specific subcollections. Users can only access data that they
 * own. Public listing of user subcollections is disallowed for privacy.
 *
 * Data Structure:
 * All data is nested under `/users/{userId}`, with further subcollections
 * for `properties`, `tenants`, `messagelogs`, and `templates`.
 *
 * Key Security Decisions:
 * - User listing is disallowed to prevent unauthorized enumeration.
 * - All write operations require authentication.
 * - Data validation is relaxed for prototyping, except for ownership checks.
 * - List operations are restricted to the owner of the data.
 *
 * Denormalization for Authorization:
 *  N/A - The data model inherently uses path-based authorization via the
 *  `/users/{userId}` structure.
 *
 * Structural Segregation:
 *  The application uses user-specific subcollections to segregate private
 *  user data, which is a secure and performant approach.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants access to a user's "properties" subcollection.
     * @path /users/{userId}/properties/{propertyId}
     */
    match /users/{userId}/properties/{propertyId} {
      // Helper function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Helper function to check if the user is the owner of the resource
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      // Read rules
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);

      // Write rules
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Grants access to a user's "tenants" subcollection.
     * @path /users/{userId}/tenants/{tenantId}
     */
    match /users/{userId}/tenants/{tenantId} {
      // Helper function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Helper function to check if the user is the owner of the resource
      function isOwner(userId) {
        return request.auth.uid == userId;
      }


      // Read rules
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);

      // Write rules
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Grants access to a user's "messagelogs" subcollection.
     * @path /users/{userId}/messagelogs/{messagelogId}
     */
    match /users/{userId}/messagelogs/{messagelogId} {
      // Helper function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Helper function to check if the user is the owner of the resource
      function isOwner(userId) {
        return request.auth.uid == userId;
      }


      // Read rules
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);

      // Write rules
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

        /**
     * @description Grants access to a user's "templates" subcollection.
     * @path /users/{userId}/templates/{templateId}
     */
    match /users/{userId}/templates/{templateId} {
      // Helper function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Helper function to check if the user is the owner of the resource
      function isOwner(userId) {
        return request.auth.uid == userId;
      }


      // Read rules
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);

      // Write rules
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

     // Only allow creating user documents
    match /users/{userId} {
        function isSignedIn() {
            return request.auth != null;
        }

        // Helper function to check if the user is the owner of the resource
        function isOwner(userId) {
            return request.auth.uid == userId;
        }
        allow create: if request.auth.uid == userId;
        allow get: if isSignedIn() && isOwner(userId);
        allow update: if isSignedIn() && isOwner(userId);
        allow delete: if isSignedIn() && isOwner(userId);
    }
  }
}