rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the requested user ID matches the authenticated user's ID.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is the owner of the existing document.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource.data != null && resource.data.userId == request.auth.uid;
    }

    /**
     * @description Rules for user-specific data.
     * @path /users/{userId}
     * @allow (create) - A user can create their own user document if the userId matches their auth.uid.
     * @allow (get, list, update, delete) - Only the user can read, update, or delete their own user document.
     * @deny (create) - A user cannot create a document with a userId that does not match their auth.uid.
     * @principle Enforces user-ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);

      /**
       * @description Rules for properties owned by a user.
       * @path /users/{userId}/properties/{propertyId}
       * @allow (create) - A user can create a property under their user ID.
       * @allow (get, list) - A user can read (get and list) properties under their user ID.
       * @allow (update, delete) - Only the user can update or delete properties under their user ID.
       * @deny (create) - A user cannot create a property under another user's ID.
       * @principle Enforces user-ownership for all operations on properties.
       */
      match /properties/{propertyId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }

      /**
       * @description Rules for tenants associated with a user.
       * @path /users/{userId}/tenants/{tenantId}
       * @allow (create) - A user can create a tenant under their user ID.
       * @allow (get, list) - A user can read (get and list) tenants under their user ID.
       * @allow (update, delete) - Only the user can update or delete tenants under their user ID.
       * @deny (create) - A user cannot create a tenant under another user's ID.
       * @principle Enforces user-ownership for all operations on tenants.
       */
      match /tenants/{tenantId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }

      /**
       * @description Rules for message logs associated with a user.
       * @path /users/{userId}/messagelogs/{messagelogId}
       * @allow (create) - A user can create a messagelog under their user ID.
       * @allow (get, list) - A user can read (get and list) messagelogs under their user ID.
       * @allow (update, delete) - Only the user can update or delete messagelogs under their user ID.
       * @deny (create) - A user cannot create a messagelog under another user's ID.
       * @principle Enforces user-ownership for all operations on message logs.
       */
      match /messagelogs/{messagelogId} {
          allow get: if isOwner(userId);
          allow list: if isOwner(userId);
          allow create: if isOwner(userId);
          allow update: if isOwner(userId);
          allow delete: if isOwner(userId);
      }

      /**
       * @description Rules for templates associated with a user.
       * @path /users/{userId}/templates/{templateId}
       * @allow (create) - A user can create a template under their user ID.
       * @allow (get, list) - A user can read (get and list) templates under their user ID.
       * @allow (update, delete) - Only the user can update or delete templates under their user ID.
       * @deny (create) - A user cannot create a template under another user's ID.
       * @principle Enforces user-ownership for all operations on templates.
       */
      match /templates/{templateId} {
          allow get: if isOwner(userId);
          allow list: if isOwner(userId);
          allow create: if isOwner(userId);
          allow update: if isOwner(userId);
          allow delete: if isOwner(userId);
      }
      
      /**
       * @description Rules for invoices associated with a user.
       * @path /users/{userId}/invoices/{invoiceId}
       * @allow (create, get, list, update, delete) - A user can manage invoices under their user ID.
       * @principle Enforces user-ownership for all operations on invoices.
       */
      match /invoices/{invoiceId} {
          allow get: if isOwner(userId);
          allow list: if isOwner(userId);
          allow create: if isOwner(userId);
          allow update: if isOwner(userId);
          allow delete: if isOwner(userId);
      }

       /**
       * @description Rules for utility bills associated with a user.
       * @path /users/{userId}/utilitybills/{utilityBillId}
       * @allow (create, get, list, update, delete) - A user can manage utility bills under their user ID.
       * @principle Enforces user-ownership for all operations on utility bills.
       */
      match /utilitybills/{utilityBillId} {
          allow read, write: if isOwner(userId);
      }
    }
  }
}
